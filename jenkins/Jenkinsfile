node {
    // Configure Poll SCM trigger to check every 2 minutes
    properties([
        pipelineTriggers([
            pollSCM('H/2 * * * *')
        ])
    ])
    
    stage('Checkout') {
        deleteDir()
        checkout scm
    }
    
    stage('Build') {
        docker.image('python:2-alpine').inside {
            sh '''
                python -m py_compile sources/add2vals.py sources/calc.py
            '''
        }
    }
    
    stage('Test') {
        docker.image('qnib/pytest').inside {
            sh 'mkdir -p test-reports'
            
            try {
                sh '''
                    py.test --verbose --junit-xml test-reports/results.xml sources/test_calc.py
                '''
            } finally {
                junit 'test-reports/results.xml'
            }
        }
    }
    
    stage('Deliver') {
        // Use python:2 image with root user
        docker.image('python:2').inside('--user root:root') {
            sh '''
                # Update package lists and install wget
                apt-get update
                apt-get install -y wget

                # Install pip and pyinstaller directly
                python -m pip install --upgrade pip
                python -m pip install pyinstaller
                
                # Create dist directory
                mkdir -p dist
                
                # Run pyinstaller
                pyinstaller --onefile sources/add2vals.py
                
                # Ensure correct permissions on output
                chmod -R 777 dist/
            '''
            
            archiveArtifacts artifacts: 'dist/add2vals', allowEmptyArchive: false
        }
    }
}